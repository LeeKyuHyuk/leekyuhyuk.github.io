<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><style id="stitches"></style><link rel="preload" href="/_next/static/css/98b299b94b0a7962.css" as="style"/><link rel="stylesheet" href="/_next/static/css/98b299b94b0a7962.css" data-n-g=""/><link rel="preload" href="/_next/static/css/5c3da54741072322.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5c3da54741072322.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-dea678fb5840c50f.js" defer=""></script><script src="/_next/static/chunks/framework-64ad27b21261a9ce.js" defer=""></script><script src="/_next/static/chunks/main-f2f237ba7e9012fc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-9b6890f28bc766f1.js" defer=""></script><script src="/_next/static/chunks/803-9fe1c131242daf24.js" defer=""></script><script src="/_next/static/chunks/785-d1ab2e5b6dacd475.js" defer=""></script><script src="/_next/static/chunks/pages/article/%5Bcategory%5D/%5Byear%5D/%5Bmonth%5D/%5Bday%5D/%5Bslug%5D-6501b82d330bbee5.js" defer=""></script><script src="/_next/static/dFiaKGJXnX9ZfXI4gZrP9/_buildManifest.js" defer=""></script><script src="/_next/static/dFiaKGJXnX9ZfXI4gZrP9/_ssgManifest.js" defer=""></script></head><body><div id="__next"></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"excerpt":" Nest.js 에 GraphQL 서버를 구축하는 방법을 정리해보았습니다. Nest.js 프로젝트 생성 npm init 를 사용하여 아래와 같이 package.json 을 생성합니다. 아래의 패키지를 설치합니다. npm install --save @nestjs/axios @nestjs/","url":"/article/graphql/2021/09/16/Building-a-GraphQL-Server-with-NestJS","frontmatter":{"title":"Nest.js로 GraphQL 서버 구축하기","date":"2021-09-16 00:12:10","category":"GraphQL"},"content":"\r\n[Nest.js](https://nestjs.com)에 GraphQL 서버를 구축하는 방법을 정리해보았습니다.\r\n\r\n# Nest.js 프로젝트 생성\r\n\r\n`npm init`를 사용하여 아래와 같이 `package.json`을 생성합니다.  \r\n![Create NestJS Project](/assets/image/2021-09-16-Building-a-GraphQL-Server-with-NestJS/2021-09-16-Building-a-GraphQL-Server-with-NestJS_1.png)\r\n\r\n아래의 패키지를 설치합니다.\r\n\r\n```bash\r\nnpm install --save @nestjs/axios @nestjs/common @nestjs/core @nestjs/platform-express reflect-metadata rxjs\r\nnpm install --save-dev @nestjs/cli @nestjs/schematics @types/express @types/node ts-loader ts-node tsconfig-paths typescript\r\n```\r\n\r\n`package.json`에 `\"main\": \"index.js\"` 행을 삭제하고 아래 내용을 추가합니다.\r\n\r\n```json\r\n  \"private\": true,\r\n  \"scripts\": {\r\n    \"build\": \"nest build\",\r\n    \"start\": \"nest start\",\r\n    \"start:dev\": \"NODE_ENV=development nest start --watch\",\r\n    \"start:debug\": \"NODE_ENV=development nest start --debug --watch\",\r\n    \"start:prod\": \"npm run build \u0026\u0026 NODE_ENV=production node dist/main\"\r\n  },\r\n```\r\n\r\n`nest-cli.json`, `tsconfig.build.json`, `tsconfig.json`을 아래와 같이 작성하여 저장합니다.\r\n\r\n**`nest-cli.json` :**\r\n\r\n```json\r\n{\r\n  \"collection\": \"@nestjs/schematics\",\r\n  \"sourceRoot\": \"src\"\r\n}\r\n```\r\n\r\n**`tsconfig.build.json` :**\r\n\r\n```json\r\n{\r\n  \"extends\": \"./tsconfig.json\",\r\n  \"exclude\": [\"node_modules\", \"dist\", \"test\", \"**/*spec.ts\"]\r\n}\r\n```\r\n\r\n**`tsconfig.json` :**\r\n\r\n```json\r\n{\r\n  \"compilerOptions\": {\r\n    \"module\": \"commonjs\",\r\n    \"declaration\": true,\r\n    \"removeComments\": true,\r\n    \"emitDecoratorMetadata\": true,\r\n    \"experimentalDecorators\": true,\r\n    \"allowSyntheticDefaultImports\": true,\r\n    \"target\": \"es2017\",\r\n    \"sourceMap\": true,\r\n    \"outDir\": \"./dist\",\r\n    \"baseUrl\": \"./\",\r\n    \"incremental\": true,\r\n    \"skipLibCheck\": true\r\n  }\r\n}\r\n```\r\n\r\n# Nest.js 프로젝트에 GraphQL 추가 및 설정\r\n\r\n아래의 패키지를 설치합니다.\r\n\r\n```bash\r\nnpm install --save @nestjs/graphql apollo-server-express graphql\r\n```\r\n\r\n`src` 폴더를 만들고 `src/app.module.ts`와 `src/main.ts`를 생성합니다.\r\n\r\n**`src/app.module.ts` :**\r\n\r\n```typescript\r\nimport { Module } from '@nestjs/common';\r\nimport { GraphQLModule } from '@nestjs/graphql';\r\n\r\n@Module({\r\n  imports: [GraphQLModule.forRoot({})],\r\n})\r\nexport class AppModule {}\r\n```\r\n\r\n위의 코드에서 `forRoot()`에 [여러 설정](https://www.apollographql.com/docs/apollo-server/v2/api/apollo-server.html#constructor-options-lt-ApolloServer-gt)을넣을 수 있습니다. [설정값](https://www.apollographql.com/docs/apollo-server/v2/api/apollo-server.html#constructor-options-lt-ApolloServer-gt)은기본 Apollo 인스턴스로 전달됩니다.  \r\n예를 들어 `playground`와 `debug`를 끄려면 다음과 같이 사용할 수 있습니다.\r\n\r\n```typescript\r\nimport { Module } from '@nestjs/common';\r\nimport { GraphQLModule } from '@nestjs/graphql';\r\n\r\n@Module({\r\n  imports: [\r\n    GraphQLModule.forRoot({\r\n      debug: false,\r\n      playground: false,\r\n    }),\r\n  ],\r\n})\r\nexport class AppModule {}\r\n```\r\n\r\n**`src/main.ts` :**\r\n\r\n```typescript\r\nimport { NestFactory } from '@nestjs/core';\r\nimport { AppModule } from './app.module';\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create(AppModule);\r\n  await app.listen(8080);\r\n}\r\nbootstrap();\r\n```\r\n\r\n# Resolver, Schema 생성\r\n\r\n아마 위의 코드를 모두 작성하고 `npm run start:dev`를 하면 `UnhandledPromiseRejectionWarning: Error: Apollo Server requires either an existing schema, modules or typeDefs`라고 오류가 발생할 것입니다.\r\n\r\n이 오류가 발생하는 이유는 Resolver, Schema가 없어서 발생하는 오류입니다.  \r\n여기서 말하는 Resolver는 GraphQL 작업(Query, Mutation, Subscription)을 데이터로 변환하기 위해 사용됩니다.\r\n\r\nSchema는 아래와 같이 정의할 수 있습니다. 간단하게 주소록에 필요한 Schema를 작성해보겠습니다.\r\n\r\n`graphql` 폴더를 생성하고 `person.graphql` 파일을 생성합니다.\r\n\r\n**`graphql/person.graphql` :**\r\n\r\n```graphql\r\ntype Person {\r\n  id: String!\r\n  name: String!\r\n  number: String\r\n  email: String\r\n}\r\n\r\ntype Query {\r\n  getAllPerson: [Person]\r\n}\r\n```\r\n\r\nGraphQL에서 사용되는 Schema와 Type이 궁금하다면 [https://graphql.org/learn/schema](https://graphql.org/learn/schema/)를 읽어보세요.\r\n\r\n그리고 `src/app.module.ts`에 `typePaths`를 추가하여 `.graphql` 확장자를 가진 파일을 GraphQL의 Schema 로 사용하도록 설정합니다.\r\n\r\n**`src/app.module.ts` :**\r\n\r\n```typescript\r\nimport { Module } from '@nestjs/common';\r\nimport { GraphQLModule } from '@nestjs/graphql';\r\n\r\n@Module({\r\n  imports: [\r\n    GraphQLModule.forRoot({\r\n      typePaths: ['./**/*.graphql'],\r\n    }),\r\n  ],\r\n})\r\nexport class AppModule {}\r\n```\r\n\r\nSchema를 만들었으니 이제 Resolver를 만들어 봅시다.\r\n\r\n`src` 폴더 안에 `models` 폴더를 생성하고, `src/models/person.resolver.ts`와 `src/models/person.module.ts` 파일을 작성합니다.  \r\n아직 데이터베이스와 연결하지 않았기 때문에 `getAllPerson` Query 요청이 오면 아래와 같은 데이터를 반환하도록 작성합니다.\r\n\r\n**`src/models/person.resolver.ts` :**\r\n\r\n```typescript\r\nimport { Query, Resolver } from '@nestjs/graphql';\r\n\r\n@Resolver('Person')\r\nexport class PersonResolver {\r\n  @Query()\r\n  async getAllPerson() {\r\n    return [\r\n      {\r\n        id: '1',\r\n        name: '이규혁',\r\n        number: '+82 10-1234-5678',\r\n        email: 'lee@kyuhyuk.kr',\r\n      },\r\n      { id: '2', name: '변정원', number: '+82 10-8765-4321' },\r\n    ];\r\n  }\r\n}\r\n```\r\n\r\n**`src/models/person.module.ts` :**\r\n\r\n```typescript\r\nimport { Module } from '@nestjs/common';\r\nimport { PersonResolver } from './person.resolver';\r\n\r\n@Module({\r\n  providers: [PersonResolver],\r\n})\r\nexport class PersonModule {}\r\n```\r\n\r\n`src/app.module.ts`에 `PersonModule`를 추가합니다.\r\n\r\n**`src/app.module.ts` :**\r\n\r\n```typescript\r\nimport { Module } from '@nestjs/common';\r\nimport { GraphQLModule } from '@nestjs/graphql';\r\nimport { PersonModule } from './models/person.module';\r\n\r\n@Module({\r\n  imports: [\r\n    GraphQLModule.forRoot({\r\n      typePaths: ['./**/*.graphql'],\r\n    }),\r\n    PersonModule,\r\n  ],\r\n})\r\nexport class AppModule {}\r\n```\r\n\r\n`npm run start:dev`를 실행하고 [http://localhost:8080/graphql](http://localhost:8080/graphql)에 접속합니다.  \r\nGraphQL Playground가 브라우저에 출력되면, 아래와 같이 입력하여 실행해봅니다.\r\n\r\n우리가 의도한 대로 동작하는 것을 확인할 수 있습니다.  \r\n![GraphQL Playground](/assets/image/2021-09-16-Building-a-GraphQL-Server-with-NestJS/2021-09-16-Building-a-GraphQL-Server-with-NestJS_2.png)\r\n\r\n# 데이터베이스와 연결\r\n\r\n이 글에서는 MongoDB를 GraphQL과 연결하도록 하겠습니다.  \r\n[https://www.mongodb.com/try/download/community](https://www.mongodb.com/try/download/community)에접속하여 MongoDB Community Server를 다운로드하고 설치합니다.\r\n\r\n간편하게 MongoDB를 사용하기 위해서 [Robo 3T](https://robomongo.org)를 사용하도록 하겠습니다.  \r\n아래와 같이 데이터 몇 개를 삽입하였습니다.  \r\n![Robo 3T - Insert Document](/assets/image/2021-09-16-Building-a-GraphQL-Server-with-NestJS/2021-09-16-Building-a-GraphQL-Server-with-NestJS_3.png)\r\n\r\nNest.js 프로젝트에 아래의 패키지를 추가합니다.\r\n\r\n```bash\r\nnpm install --save mongoose\r\n```\r\n\r\n`src/database.providers.ts`와 `src/database.module.ts` 파일을 작성하여, 데이터베이스와의 연결을 설정합니다.\r\n\r\n**`src/database.providers.ts` :**\r\n\r\n```typescript\r\nimport * as mongoose from 'mongoose';\r\n\r\nconst DATABASE_NAME = 'GraphQL';\r\n\r\nexport const databaseProviders = [\r\n  {\r\n    provide: 'DATABASE_CONNECTION',\r\n    useFactory: (): Promise\u003ctypeof mongoose\u003e =\u003e\r\n      mongoose.connect(`mongodb://localhost/${DATABASE_NAME}`),\r\n  },\r\n];\r\n```\r\n\r\n**`src/database.module.ts` :**\r\n\r\n```typescript\r\nimport { Module } from '@nestjs/common';\r\nimport { databaseProviders } from './database.providers';\r\n\r\n@Module({\r\n  providers: [...databaseProviders],\r\n  exports: [...databaseProviders],\r\n})\r\nexport class DatabaseModule {}\r\n```\r\n\r\nMongoose를 사용하면 모든 것이 Schema에서 파생됩니다.  \r\n`src`에 `schemas` 폴더를 만들고, `person.schema.ts` 파일을 작성합니다.\r\n\r\n**`src/schemas/person.schema.ts` :**\r\n\r\n```typescript\r\nimport { Field, ObjectType } from '@nestjs/graphql';\r\nimport * as mongoose from 'mongoose';\r\nimport { Document } from 'mongoose';\r\n\r\nexport const PersonSchema = new mongoose.Schema({\r\n  _id: { type: mongoose.Schema.Types.ObjectId, auto: true },\r\n  name: String,\r\n  number: String,\r\n  email: String,\r\n});\r\n\r\n@ObjectType()\r\nexport class Person extends Document {\r\n  @Field()\r\n  _id: string;\r\n\r\n  @Field()\r\n  name: string;\r\n\r\n  @Field()\r\n  number: string;\r\n\r\n  @Field()\r\n  email: string;\r\n}\r\n```\r\n\r\n위에서 만든 `PersonSchema`를 사용하여 Model Provider를 만들어봅시다.  \r\n아래와 같이 `person.providers.ts` 파일을 작성합니다.\r\n\r\n**`src/models/person.providers.ts` :**\r\n\r\n```typescript\r\nimport { Connection } from 'mongoose';\r\nimport { PersonSchema } from '../schemas/person.schema';\r\n\r\nexport const PersonProviders = [\r\n  {\r\n    provide: 'PERSON_MODEL',\r\n    useFactory: (connection: Connection) =\u003e connection.model('Person', PersonSchema, 'Person'),\r\n    inject: ['DATABASE_CONNECTION'],\r\n  },\r\n];\r\n```\r\n\r\n\u003e `PERSON_MODEL`과 `DATABASE_CONNECTION`은 `constants.ts` 파일을 따로 만들어 분리하여 보관하는 것을권장합니다.\r\n\r\n이제 `@Inject()`를 사용하여 `PersonService`에 `PERSON_MODEL`를 추가합니다.  \r\n`src/models/person.service.ts` 파일을 아래와 같이 작성합니다.\r\n\r\n**`src/models/person.service.ts` :**\r\n\r\n```typescript\r\nimport { Model } from 'mongoose';\r\nimport { Injectable, Inject } from '@nestjs/common';\r\nimport { Person } from '../schemas/person.schema';\r\n\r\n@Injectable()\r\nexport class PersonService {\r\n  constructor(\r\n    @Inject('PERSON_MODEL')\r\n    private personModel: Model\u003cPerson\u003e\r\n  ) {}\r\n\r\n  async findAll(): Promise\u003cPerson[]\u003e {\r\n    return this.personModel.find().exec();\r\n  }\r\n}\r\n```\r\n\r\n`src/models/person.module.ts`에 `DatabaseModule`과 `PersonService`, `PersonProviders`를 추가합니다.\r\n\r\n**`src/models/person.module.ts` :**\r\n\r\n```typescript\r\nimport { Module } from '@nestjs/common';\r\nimport { DatabaseModule } from '../database.module';\r\nimport { PersonProviders } from './person.providers';\r\nimport { PersonResolver } from './person.resolver';\r\nimport { PersonService } from './person.service';\r\n\r\n@Module({\r\n  imports: [DatabaseModule],\r\n  providers: [PersonResolver, PersonService, ...PersonProviders],\r\n})\r\nexport class PersonModule {}\r\n```\r\n\r\n기존에 작성했던 `src/models/person.resolver.ts`를 아래와 같이 수정하여 실제 데이터베이스에 있는 데이터를 가져오도록 구현합니다.\r\n\r\n```typescript\r\nimport { Query, Resolver } from '@nestjs/graphql';\r\nimport { Person } from 'src/schemas/person.schema';\r\nimport { PersonService } from './person.service';\r\n\r\n@Resolver('Person')\r\nexport class PersonResolver {\r\n  constructor(private personService: PersonService) {}\r\n\r\n  @Query(() =\u003e [Person])\r\n  async getAllPerson() {\r\n    return await this.personService.findAll();\r\n  }\r\n}\r\n```\r\n\r\n켜져 있는 NestJS 서버를 중단하고, `npm run start:dev`를 다시 실행한 뒤 [http://localhost:8080/graphql](http://localhost:8080/graphql)에 접속합니다.\r\n\r\nQuery를 요청하면, 아래와 같이 MongoDB에 있는 데이터가 정상적으로 나오고 있음을 확인할 수 있습니다.  \r\n![GraphQL Playground](/assets/image/2021-09-16-Building-a-GraphQL-Server-with-NestJS/2021-09-16-Building-a-GraphQL-Server-with-NestJS_4.png)\r\n\r\nQuery를 구현했으니 이제 Mutation을 구현해봅시다.\r\n\r\n`graphql/person.graphql`에 아래와 같이 Mutation을 추가합니다.\r\n\r\n**`graphql/person.graphql` :**\r\n\r\n```graphql\r\ntype Person {\r\n  id: String!\r\n  name: String!\r\n  number: String\r\n  email: String\r\n}\r\n\r\ninput CreatePersonInput {\r\n  name: String!\r\n  number: String\r\n  email: String\r\n}\r\n\r\ntype Query {\r\n  getAllPerson: [Person]\r\n}\r\n\r\ntype Mutation {\r\n  addPerson(person: CreatePersonInput): Person\r\n}\r\n```\r\n\r\n`src/schemas/person.schema.ts`에도 `CreatePersonInput`을 추가합니다.\r\n\r\n**`src/schemas/person.schema.ts` :**\r\n\r\n```typescript\r\nimport { Field, ObjectType } from '@nestjs/graphql';\r\nimport * as mongoose from 'mongoose';\r\nimport { Document } from 'mongoose';\r\n\r\nexport const PersonSchema = new mongoose.Schema({\r\n  _id: { type: mongoose.Schema.Types.ObjectId, auto: true },\r\n  name: String,\r\n  number: String,\r\n  email: String,\r\n});\r\n\r\n@ObjectType()\r\nexport class Person extends Document {\r\n  @Field()\r\n  _id: string;\r\n\r\n  @Field()\r\n  name: string;\r\n\r\n  @Field()\r\n  number: string;\r\n\r\n  @Field()\r\n  email: string;\r\n}\r\n\r\n@ObjectType()\r\nexport class CreatePersonInput {\r\n  @Field()\r\n  name: string;\r\n\r\n  @Field()\r\n  number: string;\r\n\r\n  @Field()\r\n  email: string;\r\n}\r\n```\r\n\r\n`PersonService`에 `addPerson()`을 추가합니다.\r\n\r\n**`src/models/person.service.ts` :**\r\n\r\n```typescript\r\nimport { Model } from 'mongoose';\r\nimport { Injectable, Inject } from '@nestjs/common';\r\nimport { CreatePersonInput, Person } from '../schemas/person.schema';\r\n\r\n@Injectable()\r\nexport class PersonService {\r\n  constructor(\r\n    @Inject('PERSON_MODEL')\r\n    private personModel: Model\u003cPerson\u003e\r\n  ) {}\r\n\r\n  async findAll(): Promise\u003cPerson[]\u003e {\r\n    return this.personModel.find().exec();\r\n  }\r\n\r\n  async addPerson(person: CreatePersonInput): Promise\u003cPerson\u003e {\r\n    return this.personModel.create(person);\r\n  }\r\n}\r\n```\r\n\r\n`PersonResolver`에 `addPerson` Mutation을 추가합니다.\r\n\r\n**`src/models/person.resolver.ts` :**\r\n\r\n```typescript\r\nimport { Args, Mutation, Query, Resolver } from '@nestjs/graphql';\r\nimport { CreatePersonInput, Person } from '../schemas/person.schema';\r\nimport { PersonService } from './person.service';\r\n\r\n@Resolver('Person')\r\nexport class PersonResolver {\r\n  constructor(private personService: PersonService) {}\r\n\r\n  @Query(() =\u003e [Person])\r\n  async getAllPerson() {\r\n    return await this.personService.findAll();\r\n  }\r\n\r\n  @Mutation(() =\u003e Person)\r\n  async addPerson(@Args('person') person: CreatePersonInput) {\r\n    return await this.personService.addPerson(person);\r\n  }\r\n}\r\n```\r\n\r\n켜져 있는 NestJS 서버를 중단하고, `npm run start:dev`를 다시 실행한 뒤 [http://localhost:8080/graphql](http://localhost:8080/graphql)에 접속합니다.\r\n\r\nMutation을 요청하면, 아래와 같이 MongoDB에 정상적으로 데이터가 삽입된 것을 확인할 수 있습니다.  \r\n![GraphQL Playground](/assets/image/2021-09-16-Building-a-GraphQL-Server-with-NestJS/2021-09-16-Building-a-GraphQL-Server-with-NestJS_5.png)  \r\n![Robo 3T - Documents](/assets/image/2021-09-16-Building-a-GraphQL-Server-with-NestJS/2021-09-16-Building-a-GraphQL-Server-with-NestJS_6.png)\r\n"},"__N_SSG":true},"page":"/article/[category]/[year]/[month]/[day]/[slug]","query":{"category":"graphql","year":"2021","month":"09","day":"16","slug":"Building-a-GraphQL-Server-with-NestJS"},"buildId":"dFiaKGJXnX9ZfXI4gZrP9","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>