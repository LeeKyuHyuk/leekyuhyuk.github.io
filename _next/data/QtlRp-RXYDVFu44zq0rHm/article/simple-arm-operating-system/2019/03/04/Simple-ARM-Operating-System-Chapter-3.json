{"pageProps":{"excerpt":" Source Code는 https://github.com/LeeKyuHyuk/Simple-ARM-Operating-System/tree/raspberry-pi-zero/Chapter-3/src 에 있습니다. ARM Assembly로 Raspberry Pi Zero의 GPIO를 제어하여","url":"/article/simple-arm-operating-system/2019/03/04/Simple-ARM-Operating-System-Chapter-3","frontmatter":{"title":"Chapter 3: GPIO를 제어해보자! (ARM Assembly)","date":"2019-03-04 23:07:03","category":"Simple-ARM-Operating-System"},"content":"\n> Source Code는\n> [https://github.com/LeeKyuHyuk/Simple-ARM-Operating-System/tree/raspberry-pi-zero/Chapter-3/src](https://github.com/LeeKyuHyuk/Simple-ARM-Operating-System/tree/raspberry-pi-zero/Chapter-3/src)에\n> 있습니다.\n\n<br>\nARM Assembly로 Raspberry Pi Zero의 GPIO를 제어하여 ACT LED를 켜고 끄는 것을 만들어보겠습니다.\n\n![Raspberry Pi Zero ACT LED](/assets/image/2019-03-04-Simple-ARM-Operating-System-Chapter-3/2019-03-04-Simple-ARM-Operating-System-Chapter-3_1.png)\n\nRaspberry Pi Zero의 ACT LED는 GPIO `47`을 사용하고 있습니다.\n\n### GPIO (General Purpose Input/Output)\n\n모든 GPIO 핀은 소프트웨어로 입력 또는 출력 핀으로 지정 될 수 있으며 다양한 목적으로 사용됩니다.  \n이번 예제에서는 GPIO 4번에 연결된 LED를 켜보겠습니다.\n\n우선 코드를 작성하기전에 라즈베리파이의 Memory Map부터 보도록 하겠습니다.  \n`BCM2835-ARM-Peripherals.pdf`의 5페이지를 보면 라즈베리파이1의 Memory Map은 아래와 같다고 설명하고있\n습니다.  \n![BCM2835 ARM Peripherals](/assets/image/2019-03-04-Simple-ARM-Operating-System-Chapter-3/2019-03-04-Simple-ARM-Operating-System-Chapter-3_2.png)  \n그림을 보면 BCM2835를 사용하는 Raspberry Pi Zero의 I/O Peripherals의 물리 주소는 `0x20000000`에서 시\n작한다고 합니다.\n\n- 시스템 메모리는 ARM과 VC 파트로 분할되며, 부분적으로 공유됩니다. (예를 들면, Frame Buffer)\n- ARM의 메모리 매핑 된 레지스터는 `0x20000000`부터 시작합니다.\n  - BCM2835 메뉴얼에 있는 `0x7E000000` 오프셋을 `0x20000000`로 사용하면 됩니다.\n\nRaspberry Pi Zero의 GPIO는 아래와 같습니다.  \n![Raspberry Pi Zero GPIO](/assets/image/2019-03-04-Simple-ARM-Operating-System-Chapter-3/2019-03-04-Simple-ARM-Operating-System-Chapter-3_3.png)\n\n> GPIO 핀의 번호 배정은 숫자 순서가 아닙니다.  \n> GPIO 핀 `0`과 `1`은 라즈베리파이 보드의 물리적 핀 `27`과 `28`에 있지만 고급 사용을 위해 예약되어있\n> 습니다\n\n`BCM2835-ARM-Peripherals.pdf`의 90 페이지를 보면, GPIO는 아래와 같이 41개의 레지스터를 가지고 있습니\n다.\n\n| Address        | Field Name | Description                           | Size | Read/Write |\n| -------------- | ---------- | ------------------------------------- | ---- | ---------- |\n| `0x 7E20 0000` | GPFSEL0    | GPIO Function Select 0                | 32   | R/W        |\n| `0x 7E20 0004` | GPFSEL1    | GPIO Function Select 1                | 32   | R/W        |\n| `0x 7E20 0008` | GPFSEL2    | GPIO Function Select 2                | 32   | R/W        |\n| `0x 7E20 000C` | GPFSEL3    | GPIO Function Select 3                | 32   | R/W        |\n| `0x 7E20 0010` | GPFSEL4    | GPIO Function Select 4                | 32   | R/W        |\n| `0x 7E20 0014` | GPFSEL5    | GPIO Function Select 5                | 32   | R/W        |\n| `0x 7E20 0018` | -          | Reserved                              | -    | -          |\n| `0x 7E20 001C` | GPSET0     | GPIO Pin Output Set 0                 | 32   | W          |\n| `0x 7E20 0020` | GPSET1     | GPIO Pin Output Set 1                 | 32   | W          |\n| `0x 7E20 0024` | -          | Reserved                              | -    | -          |\n| `0x 7E20 0028` | GPCLR0     | GPIO Pin Output Clear 0               | 32   | W          |\n| `0x 7E20 002C` | GPCLR1     | GPIO Pin Output Clear 1               | 32   | W          |\n| `0x 7E20 0030` | -          | Reserved                              | -    | -          |\n| `0x 7E20 0034` | GPLEV0     | GPIO Pin Level 0                      | 32   | R          |\n| `0x 7E20 0038` | GPLEV1     | GPIO Pin Level 1                      | 32   | R          |\n| `0x 7E20 003C` | -          | Reserved                              | -    | -          |\n| `0x 7E20 0040` | GPEDS0     | GPIO Pin Event Detect Status 0        | 32   | R/W        |\n| `0x 7E20 0044` | GPEDS1     | GPIO Pin Event Detect Status 1        | 32   | R/W        |\n| `0x 7E20 0048` | -          | Reserved                              | -    | -          |\n| `0x 7E20 004C` | GPREN0     | GPIO Pin Rising Edge Detect Enable 0  | 32   | R/W        |\n| `0x 7E20 0050` | GPREN1     | GPIO Pin Rising Edge Detect Enable 1  | 32   | R/W        |\n| `0x 7E20 0054` | -          | Reserved                              | -    | -          |\n| `0x 7E20 0058` | GPFEN0     | GPIO Pin Falling Edge Detect Enable 0 | 32   | R/W        |\n| `0x 7E20 005C` | GPFEN1     | GPIO Pin Falling Edge Detect Enable 1 | 32   | R/W        |\n| `0x 7E20 0060` | -          | Reserved                              | -    | -          |\n| `0x 7E20 0064` | GPHEN0     | GPIO Pin High Detect Enable 0         | 32   | R/W        |\n| `0x 7E20 0068` | GPHEN1     | GPIO Pin High Detect Enable 1         | 32   | R/W        |\n| `0x 7E20 006C` | -          | Reserved                              | -    | -          |\n| `0x 7E20 0070` | GPLEN0     | GPIO Pin Low Detect Enable 0          | 32   | R/W        |\n| `0x 7E20 0074` | GPLEN1     | GPIO Pin Low Detect Enable 1          | 32   | R/W        |\n| `0x 7E20 0078` | -          | Reserved                              | -    | -          |\n| `0x 7E20 007C` | GPAREN0    | GPIO Pin Async. Rising Edge Detect 0  | 32   | R/W        |\n| `0x 7E20 0080` | GPAREN1    | GPIO Pin Async. Rising Edge Detect 1  | 32   | R/W        |\n| `0x 7E20 0084` | -          | Reserved                              | -    | -          |\n| `0x 7E20 0088` | GPAFEN0    | GPIO Pin Async. Falling Edge Detect 0 | 32   | R/W        |\n| `0x 7E20 008C` | GPAFEN1    | GPIO Pin Async. Falling Edge Detect 1 | 32   | R/W        |\n| `0x 7E20 0090` | -          | Reserved                              | -    | -          |\n| `0x 7E20 0094` | GPPUD      | GPIO Pin Pull-up/down Enable          | 32   | R/W        |\n| `0x 7E20 0098` | GPPUDCLK0  | GPIO Pin Pull-up/down Enable Clock 0  | 32   | R/W        |\n| `0x 7E20 009C` | GPPUDCLK1  | GPIO Pin Pull-up/down Enable Clock 1  | 32   | R/W        |\n| `0x 7E20 00A0` | -          | Reserved                              | -    | -          |\n| `0x 7E20 00B0` | -          | Test                                  | 4    | R/W        |\n\n`GPFSEL`, `GPSET`, `GPCLR`와 같이 다양한 레지스터가 있습니다.\n\n우선\n[`BCM2835-ARM-Peripherals.pdf`](https://github.com/LeeKyuHyuk/Simple-ARM-Operating-System/raw/raspberry-pi-zero/References/documentation/BCM2835-ARM-Peripherals.pdf)의\n91페이지를 보면, `GPFSEL` 레지스터는 GPIO 기능을 선택하는 레지스터라고 설명하고 있습니다.  \n`GPFSEL0`은 GPIO 0번~9번을 담당하고, [`2`:`0`] 비트는 GPIO 0번, [`5`:`3`] 비트는 GPIO 1번을 담당하고\n있습니다.  \n3비트씩 GPIO핀을 담당하고 있으며, `000`을 지정하면 입력(Input), `001`은 출력(Output)을 설정하게 됩니\n다.  \nGPIO 47번 핀을 출력으로 설정하려면 `GPFSEL4` 레지스터의 [`23`:`21`] 비트를 `001`로 설정하면 됩니다.\n\n[`BCM2835-ARM-Peripherals.pdf`](https://github.com/LeeKyuHyuk/Simple-ARM-Operating-System/raw/raspberry-pi-zero/References/documentation/BCM2835-ARM-Peripherals.pdf)의\n95페이지를 보면 `GPSET`에 대해 설명하고 있습니다.  \n`GPSET`은 GPIO 핀의 출력을 설정하는 레지스터인데, `GPSET0`과 `GPSET1`이 있습니다. `GPSET` 레지스터의\n`n`번 비트는 GPIO `n`번 핀을 정의하며, `0`을 쓰는 것은 아무 효과가 없습니다.  \n`GPSET0`은 GPIO `0`번 ~ `31`번, `GPSET1`은 GPIO `32`번 ~ `53`번을 담당합니다.  \nGPIO 47번 핀을 출력(Output)으로 설정했고, LED를 켜고 싶으니 `GPSET0`의 `15`번 비트를 `1`로 설정하면\n됩니다. 메뉴얼을 잘 읽을줄만 알면 작업하기가 편해집니다.\n\n**`boot.S`:**\n\n```assembly\n.equ PERI_BASE ,0x20000000             @ Peripheral Base Address\n.equ GPIO_BASE ,PERI_BASE + 0x00200000 @ GPIO Base Address\n\n.section \".text.boot\"\n.globl _start\n\n_start:\n    @--------------------------------------------------\n    @ ACT LED Blink\n    @--------------------------------------------------\n    LDR R0 ,=GPIO_BASE                 @ R0에 GPIO_BASE 주소를 넣습니다.\n    MOV R1 ,#1                         @ R1에 1을 넣습니다.\n    LSL R1 ,#21                        @ R1을 21번 Left Shift하여\n                                       @ R1의 21번 비트를 1로 설정합니다\n                                       @ 이렇게 하면, GPFSEL0의 [23:21]\n                                       @ 비트를 001로 설정하게 됩니다.\n    STR R1 ,[R0, #0x0010]              @ R0(0x20200000) + GPFSEL4(0x0010)에\n                                       @ R1의 값을 넣습니다.\n\n    MOV R1 ,#1                         @ R1에 1을 넣습니다.\n    LSL R1 ,#15                        @ 15번 Left Shift하여 R1의 15번 비트를\n                                       @ 1로 설정합니다.\n    STR R1 ,[R0, #0x0020]              @ R0(0x20200000) + GPSET1(0x0020)에\n                                       @ R1의 값을 넣습니다.\n                                       @ GPIO 47번을 LOW로 설정하면 LED가 켜집니다.\n\n    b .                                @ 프로그램이 끝나지 않도록 제자리에서 무한루프\n\n    .end\n```\n\n**`linker.ld`:**\n\n```\nSECTIONS\n{\n    . = 0x8000;\n    .text : { *(.text.boot) }\n}\n```\n\n**`Makefile`:**\n\n```\nSRCS = $(wildcard *.c)\nOBJS = $(SRCS:.c=.o)\nCFLAGS = -O2 -Wall -Wextra -fpic -ffreestanding -std=gnu99\n\nall: clean kernel.bin\n\nboot.o: boot.S\n\tarm-none-eabi-gcc $(CFLAGS) -c boot.S -o boot.o\n\nkernel.bin: boot.o $(OBJS)\n\tarm-none-eabi-gcc -T linker.ld -o kernel.elf -ffreestanding -O2 -nostdlib boot.o\n\tarm-none-eabi-objcopy kernel.elf -O binary kernel.bin\n\tarm-none-eabi-objdump -D kernel.elf > kernel.dump\n\nclean:\n\trm kernel.elf kernel.bin *.o >/dev/null 2>/dev/null || true\n```\n\n### 작성한 코드를 빌드하여 실제 Raspberry Pi Zero에서 실행해보자!\n\n위와 같이 `Makefile`까지 모두 작성했다면 터미널에 `make`를 입력하여 빌드합니다.  \n빌드가 완료되면 `kernel.bin` 파일이 생성됩니다.\n\nSDCard를 FAT32로 포맷합니다.  \n그리고,\n[/References/boot](https://github.com/LeeKyuHyuk/Simple-ARM-Operating-System/tree/raspberry-pi-zero/References/boot)에\n있는 `bootcode.bin`, `config.txt`, `start.elf`를 모두 복사합니다.  \n방금 빌드한 `kernel.bin`도 함께 복사합니다.  \n![SDCard files](/assets/image/2019-03-04-Simple-ARM-Operating-System-Chapter-3/2019-03-04-Simple-ARM-Operating-System-Chapter-3_4.png)\n\n> SDCard에 있는 `config.txt`에는 `kernel=kernel.bin`이라는 설정만 있습니다. 이 설정은 `kernel.bin`을\n> 사용하여 부팅하겠다는 뜻입니다.\n\nSDCard를 Raspberry Pi Zero에 넣고, 부팅하면 아래와 같이 ACT LED가 켜지는 것을 확인할 수 있습니다.  \n![Raspberry Pi Zero ACT LED On](/assets/image/2019-03-04-Simple-ARM-Operating-System-Chapter-3/2019-03-04-Simple-ARM-Operating-System-Chapter-3_5.png)\n"},"__N_SSG":true}